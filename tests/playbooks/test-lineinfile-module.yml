---
# Lineinfile 模块功能测试
- name: Test Lineinfile Module
  hosts: all
  tasks:
    # 测试 1: 创建文件并添加行
    - name: Create file with first line
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        line: "# Configuration File"
        create: yes
      register: create_result

    - name: Show create result
      debug:
        msg: "Create file: changed={{ create_result.changed }}"

    # 测试 2: 添加配置项到末尾（默认行为）
    - name: Add server port config
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        line: "server_port=8080"

    - name: Add server host config
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        line: "server_host=localhost"

    # 测试 3: 验证文件内容
    - name: Read file content
      shell: cat /tmp/ansigo_lineinfile_test.conf
      register: content1

    - name: Show file content
      debug:
        msg: "{{ content1.stdout }}"

    # 测试 4: 使用 regexp 替换行
    - name: Update server port with regexp
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        regexp: "^server_port="
        line: "server_port=9090"
      register: update_result

    - name: Show update result
      debug:
        msg: "Update port: changed={{ update_result.changed }}"

    # 测试 5: 验证替换结果
    - name: Verify port was updated
      shell: grep "server_port" /tmp/ansigo_lineinfile_test.conf
      register: port_check

    - name: Show port value
      debug:
        msg: "Port line: {{ port_check.stdout }}"

    # 测试 6: 幂等性测试 - 再次运行相同操作
    - name: Update server port again (should not change)
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        regexp: "^server_port="
        line: "server_port=9090"
      register: idempotent_result

    - name: Verify idempotency
      debug:
        msg: "Idempotent test: changed={{ idempotent_result.changed }} (should be false)"

    # 测试 7: 使用 insertafter 在特定位置插入
    - name: Insert comment after header
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        line: "# Server Configuration"
        insertafter: "^# Configuration File"

    # 测试 8: 使用 insertbefore 在开头插入
    - name: Insert line at beginning
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        line: "# Generated by AnsiGo"
        insertbefore: "BOF"

    # 测试 9: 查看最终内容
    - name: Read final content
      shell: cat /tmp/ansigo_lineinfile_test.conf
      register: content2

    - name: Show final content
      debug:
        msg: "{{ content2.stdout }}"

    # 测试 10: 删除行 (state=absent)
    - name: Remove server_host line
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        regexp: "^server_host="
        state: absent
      register: remove_result

    - name: Show remove result
      debug:
        msg: "Remove line: changed={{ remove_result.changed }}"

    # 测试 11: 验证删除结果
    - name: Verify line was removed
      shell: grep "server_host" /tmp/ansigo_lineinfile_test.conf
      register: host_check
      failed_when: host_check.rc == 0
      changed_when: false

    # 测试 12: 使用 insertafter EOF 在末尾添加
    - name: Add footer at end of file
      lineinfile:
        path: /tmp/ansigo_lineinfile_test.conf
        line: "# End of Configuration"
        insertafter: "EOF"

    # 测试 13: 验证最终文件
    - name: Show final file content
      shell: cat /tmp/ansigo_lineinfile_test.conf
      register: final_content

    - name: Display final content
      debug:
        msg: "{{ final_content.stdout }}"

    # 测试 14: 清理测试文件
    - name: Clean up test file
      file:
        path: /tmp/ansigo_lineinfile_test.conf
        state: absent

    # 测试 15: 验证文件已删除
    - name: Verify cleanup
      shell: test -f /tmp/ansigo_lineinfile_test.conf
      register: cleanup_check
      failed_when: cleanup_check.rc == 0
      changed_when: false
