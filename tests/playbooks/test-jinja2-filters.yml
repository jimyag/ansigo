---
# 测试 Jinja2 过滤器
- name: Test Jinja2 Filters
  hosts: webservers
  gather_facts: false
  vars:
    test_string: "Hello World"
    test_arch: "x86_64"
    test_os: "Linux"
    test_list: ["item1", "item2", "item3"]
    test_dict:
      key1: "value1"
      key2: "value2"
    systemd_unit_name: "mihomo.service"
    empty_string: ""
    base_url: "https://dl.example.com/bin"
    os_type: "Linux"
    architecture: "x86_64"
    binary_name: "mihomo"
  tasks:
    # ========== 测试 default 过滤器 (使用频率: 51次) ==========
    - name: Test default filter - with undefined variable
      debug:
        msg: "Undefined var with default: {{ undefined_var | default('DEFAULT_VALUE') }}"

    - name: Test default filter - with defined variable
      debug:
        msg: "Defined var: {{ test_string | default('fallback') }}"

    - name: Test default filter - with empty string
      debug:
        msg: "Empty string: '{{ empty_string | default('FALLBACK') }}'"

    - name: Test default filter - nested default
      debug:
        msg: "Nested default: {{ not_defined | default('fallback_value') }}"

    # ========== 测试 replace 过滤器 (使用频率: 12次) ==========
    - name: Test replace filter - single replacement
      debug:
        msg: "Arch amd64: {{ test_arch | replace('x86_64', 'amd64') }}"

    - name: Test replace filter - chained replacements
      debug:
        msg: "Arch arm64: {{ 'aarch64' | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }}"

    - name: Test replace filter - homelab URL pattern
      debug:
        msg: "Binary URL: /{{ test_os | lower }}/{{ test_arch | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }}/binary"

    # ========== 测试 lower 过滤器 (使用频率: 6次) ==========
    - name: Test lower filter
      debug:
        msg: "OS lowercase: {{ test_os | lower }}"

    - name: Test lower filter - mixed case
      debug:
        msg: "Mixed: {{ 'MiXeD_CaSe' | lower }}"

    # ========== 测试 length 过滤器 (使用频率: 3次) ==========
    - name: Test length filter - string
      debug:
        msg: "String length: {{ test_string | length }}"

    - name: Test length filter - list
      debug:
        msg: "List length: {{ test_list | length }}"

    - name: Test length filter - dict
      debug:
        msg: "Dict length: {{ test_dict | length }}"

    - name: Test length filter - in when condition (should run)
      debug:
        msg: "✓ Unit name is valid (length > 0)"
      when: systemd_unit_name | length > 0

    - name: Test length filter - empty string (should be skipped)
      debug:
        msg: "✗ This should be skipped"
      when: empty_string | length > 0

    - name: Verify empty string test was skipped
      debug:
        msg: "✓ Empty string test was correctly skipped"

    # ========== 测试过滤器组合 ==========
    - name: Test filter combination - default + lower + replace
      debug:
        msg: "Combined: {{ (undefined_var | default('LINUX')) | lower | replace('linux', 'unix') }}"

    - name: Test homelab complete binary download URL
      debug:
        msg: "Download URL: {{ base_url }}/{{ os_type | lower }}/{{ architecture | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }}/{{ binary_name }}"

    - name: Test upper filter (bonus)
      debug:
        msg: "Uppercase: {{ 'hello' | upper }}"

    # ========== 最终总结 ==========
    - name: Summary
      debug:
        msg: |
          ✓ All Jinja2 filter tests passed!
          - default filter: ✓ (51 uses in homelab)
          - replace filter: ✓ (12 uses in homelab)
          - lower filter: ✓ (6 uses in homelab)
          - length filter: ✓ (3 uses in homelab)
          - upper filter: ✓ (bonus)
          - Filter chaining: ✓
